<?xml version="1.0"?>
<system>
 <config>
  <boolean name="xhcidbg_enabled" value="true"/>
  <boolean name="dbgserver_serial_enabled" value="true"/>
  <boolean name="dbgserver_sink_pcspkr" value="false"/>
  <boolean name="dbgserver_sink_shmem" value="false"/>
  <boolean name="pciconf_emulation_enabled" value="false"/>
  <string name="logchannel_size" value="16#0002_0000#"/>
 </config>

 <expressions>
  <expression name="dbgserver_sink_serial">
   <and>
    <variable name="dbgserver_serial_enabled"/>
    <variable name="serial_supported"/>
   </and>
  </expression>
  <expression name="dbgserver_sink_xhcidbg">
   <and>
    <variable name="xhcidbg_enabled"/>
    <variable name="xhcidbg_supported"/>
   </and>
  </expression>
 </expressions>

 <memory>
  <memory name="crash_audit" physicalAddress="16#0001_00a1_1000#" size="16#1000#" caching="UC" type="subject_crash_audit"/>
  <memory name="bb|ram" size="16#1000_0000#" caching="WB" type="subject"/>
  <memory name="control_sm" size="16#1000#" caching="WB">
   <fill pattern="16#ff#"/>
   <hash value="none"/>
  </memory>
  <memory name="control_time" size="16#1000#" caching="WB">
   <fill pattern="16#ff#"/>
   <hash value="none"/>
  </memory>
  <memory name="status_sm" size="16#1000#" caching="WB">
   <hash value="none"/>
  </memory>
  <memory name="status_time" size="16#1000#" caching="WB">
   <hash value="none"/>
  </memory>
 </memory>

 <events>
  <event name="system_panic" mode="kernel"/>
  <event name="system_poweroff" mode="kernel"/>
  <event name="system_reboot" mode="kernel"/>
  <event name="trap_to_sm" mode="switch"/>
  <event name="resume_bb" mode="switch"/>
  <event name="timer_bb" mode="self"/>
 </events>

 <channels>
  <channel name="testchannel" size="16#1000#" hasEvent="asap"/>
  <channel name="time_info" size="16#1000#"/>
  <channel name="debuglog_subject_sm" size="$logchannel_size"/>
  <channel name="debuglog_subject4" size="$logchannel_size"/> <!-- time subject -->
 </channels>

 <components>
  <component name="bb" profile="native">
   <depends>
    <library ref="libmutime"/>
   </depends>
   <provides>
    <memory executable="true" logical="blob" size="16#0004_0000#" type="subject_binary" virtualAddress="16#0010_0000#" writable="true">
     <file filename="bb" offset="none"/>
    </memory>
   </provides>
  </component>
 </components>

 <subjects>
  <include href="subject_time.xml"/>

  <subject name="bb">
   <vcpu>
    <vmx>
     <masks>
      <cr4>
       <OSSupportFXSAVE>0</OSSupportFXSAVE>
       <OSSupportSIMDExceptions>0</OSSupportSIMDExceptions>
       <FSGSBASEEnable>0</FSGSBASEEnable>
       <XSAVEEnable>0</XSAVEEnable>
      </cr4>
     </masks>
    </vmx>
    <msrs>
     <!-- IA32_GS_BASE -->
     <msr start="16#c000_0101#" end="16#c000_0101#" mode="rw"/>
    </msrs>
    <registers>
     <gpr>
      <rip>16#0010_00f6#</rip>
     </gpr>
    </registers>
   </vcpu>
   <memory>
    <memory executable="true" logical="ram" physical="bb|ram" virtualAddress="16#0014_0000#" writable="true"/>
   </memory>
   <events>
    <source>
     <group name="vmx_exit">
      <default physical="trap_to_sm"/>
      <event id="0" logical="exception" physical="system_panic">
       <system_panic/>
      </event>
     </group>
     <group name="vmcall">
      <event id="31" logical="timer" physical="timer_bb"/>
     </group>
    </source>
    <target>
     <event logical="resume_after_trap" physical="resume_bb"/>
     <event logical="timer" physical="timer_bb">
      <inject_interrupt vector="255"/>
     </event>
    </target>
   </events>
   <channels>
    <reader logical="response" physical="testchannel" virtualAddress="16#0001_0000_0000#" vector="230"/>
   </channels>
   <component ref="bb">
    <map logical="time_info" physical="time_info"/>
   </component>
  </subject>

  <subject name="sm">
   <events>
    <source>
     <group name="vmx_exit">
      <default physical="system_panic">
       <system_panic/>
      </default>
     </group>
    </source>
   </events>
   <monitor>
    <state subject="bb" logical="monitor_state" virtualAddress="16#001e_0000#" writable="true"/>
   </monitor>
   <component ref="sm">
    <map logical="time_info" physical="time_info"/>
    <map logical="debuglog" physical="debuglog_subject_sm"/>
    <map logical="status" physical="status_sm"/>
    <map logical="control" physical="control_sm"/>
    <map logical="handle_subject_trap" physical="trap_to_sm"/>
    <map logical="resume_subject" physical="resume_bb"/>
    <map logical="inject_something" physical="testchannel"/>
   </component>
  </subject>

  <subject name="dbgserver">
   <events>
    <source>
     <group name="vmx_exit">
      <default physical="system_panic">
       <system_panic/>
      </default>
     </group>
    </source>
   </events>
   <component ref="dbgserver">
    <map logical="log_channel1" physical="debuglog_subject_sm"/>
    <map logical="log_channel2" physical="debuglog_subject4"/>
    <include href="subject_dbgserver_common.xml"/>
   </component>
  </subject>
 </subjects>

 <scheduling tickRate="1000">
 <partitions>
  <partition name="bb">
   <group>
    <subject name="bb"/>
    <subject name="sm"/>
   </group>
  </partition>
  <partition name="dbgserver">
   <group>
    <subject name="dbgserver"/>
   </group>
  </partition>
  <partition name="time">
   <group>
    <subject name="time"/>
   </group>
  </partition>
 </partitions>
  <majorFrame>
   <cpu id="0">
    <minorFrame partition="bb" ticks="2"/>
    <minorFrame partition="bb" ticks="2"/>
    <minorFrame partition="bb" ticks="2"/>
    <minorFrame partition="bb" ticks="2"/>
    <minorFrame partition="bb" ticks="2"/>
   </cpu>
   <cpu id="1">
    <minorFrame partition="time" ticks="1"/>
    <minorFrame partition="dbgserver" ticks="9"/>
   </cpu>
  </majorFrame>
 </scheduling>

 </system>
